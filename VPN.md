#VPN(Virtual Private Network)
<pre>
1.数据要加密，所以就有了加密算法（1 类似加密函数），加密函数直接加密数据会不安全，因为别人用解密函数直接可以解密，所以就有了共享密钥，例如：m(y+x)=c【m是加密函数，y是预共享密钥，x是用户数据，c是加密后的数据】，c到对端后再用解密函数来解密，得出x,例如：n(y+c)=x【n是解密函数，y是预共享密钥，c是加密后的用户数据，x是解密后的数据】
2.由于数据可能被黑客或者外来人侵害（1.来源更改，2.数据更改），所以要用完整校验算法（2 也称hash值或散列值，有MD5和SHA两种算法）来算取是否未被黑客任何更改，完整校验算法使用例如：hash值（也称散列值），算出来的数字签名是无法被解密的，总的就是说通过完整校验算法加密后的数据是无法被还原的。工作过程：一端用完整校验算法的密钥key（完整校验算法本身的密钥key）和用户数据通过完整校验算法来算出一个数字签名，这一端把算好的数字签名和用户数据发送给另一端，另一端收到后也同样用完整校验算法的密钥key和用户数据通过完整校验算法来算出一个数字签名，然后这一端用自己算出来的数字签名和对端的数字签名进行比对，如果吻合就确定数据完整性安全，可以进行正常数据传输了。
3.VPN连接并不是一次性的，无论是管理连接传输集还是数据连接传输集都有一个生存周期与之关联，一旦到期连接便会被终止，所以有了生命周期（3），当达到这个生命周期阀值时就会断开连接，如果需要继续传输VPN数据，连接需要重新被构建，这种设计主要是出于安全性的考虑的。
4.密钥管理（4 DH组1，2，5，7[思科没有7]），工作过程：密钥管理双方交换公钥获得对方的公钥，然后用公钥和自己私钥通过DH组加密算法算出一个新的共享密钥，对端要解密就必须先求出共享密钥后才能用解密算法解密数据，求出共享密钥使用DH组解密算法代入对方公钥和自己私钥，使得自己私钥跟自己公钥，对方私钥和公钥配对，成功后方可解密出共享密钥。如果公司需要一小时更换一次秘钥，只需让非对称加密算法（DH组）一小时重新计算一次即可，而且由于非对称加密算法的私钥不会在网络上传输，其安全性也可得到保障。
5.设备身份验证时最常使用的方法就是预共享秘钥（5），即在对等体之间通过带外的方式共享秘钥，并存储在设备的本地。设备验证的过程可以通过加密算法或HMAC功能两种方法实现，而加密算法很少用于身份验证，多数情况都会通过HMAC功能实现。


1.建立管理连接传输集

IPSec使用ISAKMP/IKE阶段1来构建一个安全的管理连结。这里需要注意的是，这个管理连接只是一个准备工作，它不被用来传输实际的数据。在配置设备实现此步骤前，网络工程师需要明确设备如何实现验证，使用何种加密及认证算法，使用哪种DH组等问题

2.建立数据连接传输集

IPSec基于安全的管理连接协商建立安全的数据连接，而ISAKMP/IKE阶段2就是用来完成这个任务的，数据连接用于传输真正的用户数据。在配置设备实现此步骤前，网络工程师需要明确使用何种安全协议，针对具体的安全协议应使用加密或验证算法，以及数据的传输模式（隧道模式或传输模式）等问题。

3.流量触发IPSec

一般来说，IPSec建立过程是由对等体之间发送的流量触发的，一旦有VPN流量经过VPN网关，连接过程便开始建立了。当然，手工配置也可以实现这一过程。在配置设备实现此步骤前，网络工程师需要明确哪些流量需要被“保护”。

IKE使用UDP端口500，一般来说，ISAKMP和IKE关键字可互换使用。
ISAKMP/IKE阶段1的交换过程有两个模式：主模式和积极模式。积极模式比主模式快，主模式比积极模式安全。

Crypto map的功能就是将所有的信息组织在一起构建ipsec会话。通常路由器的接口上只对应一个crypto map，一台路由器可以在多个接口上实现流量保护，这时可能就需要多个crypto map了。
Crypto map有两种类型：静态的crypto map和动态的crypto。在构建L2L会话时通常会使用静态的，具体配置命令如下。
crypto map的序列号，其范围是1-65535，数值越小，优先级越高。
Set transform-set：指定传输集的名称，这里最多可以列出六个传输集的名称。
Set PFS：（PFS:perfect forward secrecy，完美转发保密）保证两个阶段中的秘钥只能使用一次，进一步增强了安全性，但使用PFS可能占用设备更多的资源。Set pfs命令用于启用这项功能并指定使用哪个DH秘钥组，这是一条可选命令。
Set security-association lifetime：用于指定SA的生存周期。默认情况下，cisco的设备已经设定数据连接的生存周期为3600s或4608000KB，相当于一小时内以10Mb/s速率传输的流量。生存周期的阈值是由时间和流量两个方面的因素决定的。且相当于任何一项到达阈值的限制时，SA就会被重新协商建立。
如果在IPSEC对等体之间只设置lifetime，即使没有ipsec流量传递，SA也始终处于激活状态，如果在***设备上配置了很多ipsec连接，这些暂时没有实际意义的SA就会占用设备的内存和CPU资源。从IOS12.2（15）T开始，cisco为数据SA引入空闲超时计时器，如果没有流量通过SA传输，SA就会被设备自动删除。
Set security-association idle-time命令用于设定空闲超时计数器，范围为60-86400s。默认情况下，空闲超时计时器是关闭的。

从报文结果不难发现，AH协议只能实现验证功能，而并未提供任何形式的数据加密，而且正因为其对整个IP数据报文实现验证功能，所以他与NAT或PAT不能一起使用。
有黑客对IP包头内容进行篡改，ESP是无法检测到的。这一点一点却使ESP可以和NAT一起共用。但是，无论是ESP还是AH都无法和PAT一起使用，这是由于PAT要修改第四层的数据包头。
</pre>